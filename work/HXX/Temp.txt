package lab2;

import java.util.List;
import java.io.UnsupportedEncodingException;
import java.sql.*;

import com.opensymphony.xwork2.ActionSupport;

public class AddBooks extends ActionSupport {
	public List<Book> books;
	public String errorMessage;
	private static final long serialVersionUID = 1L;
	// JDBC 驱动名及数据库 URL
	static final String JDBC_DRIVER = "com.mysql.jdbc.Driver";
	static final String DB_URL = "jdbc:mysql://localhost:3306/bookdb"
			+ "?useUnicode=true&characterEncoding=GBK";

	// 数据库的用户名与密码，需要根据自己的设置
	static final String USER = "root";
	static final String PASS = "pk188488";
	Connection conn = null;
	PreparedStatement sql = null;
	Statement sqla=null;
	ResultSet rs=null;

	public void setBooks(List<Book> books) {
		this.books = books;
	}

	public List<Book> getBooks() {
		return books;
	}
	
	public void setErrorMessage(String errorMessage){
		this.errorMessage=errorMessage;
	}
	
	public String getErrorMessage(){
		return errorMessage;
	}
	

	public String execute() throws UnsupportedEncodingException {
		System.out.println(books.size());
		for (Book p : books) {
			System.out.println(p.getTitle() + " | " + p.getISBN());
		}
		try {
			// regist driver
			Class.forName("com.mysql.jdbc.Driver");
			// create a connection
			conn = DriverManager.getConnection(DB_URL, USER, PASS);
			if (!conn.isClosed()) {
				System.out.println("Succeeded connecting to the Database!");
				sql = conn.prepareStatement("INSERT INTO book VALUES(?,?,?,?,?,?)");
				sql.setString(1, books.get(0).getISBN());
//				sql.setString(2, new String(books.get(0).getTitle().getBytes(),"utf-8"));
				sql.setString(2,  books.get(0).getTitle());
				sql.setString(3, books.get(0).getAuthorID());
				sql.setString(4, books.get(0).getPublisher());
				sql.setDate(5, new java.sql.Date(books.get(0).getPublishDate().getTime()));
				sql.setString(6, books.get(0).getPrice());
				sql.executeUpdate();
				sql.close();
				sqla=conn.createStatement();
				rs=sqla.executeQuery("SELECT * FROM author where authorID='"+books.get(0).getAuthorID()+"'");
				if(!rs.next()){
					errorMessage=("作者不存在，添加作者！");
					return INPUT;
				}
				conn.close();
				//System.out.println("测试中文是否乱码:"+books.get(0).getTitle());
				System.out.println("Succeeded Insertion");
			} else {
				System.out.println("Error");
				return ERROR;
			}
			
		}
		// 捕获加载驱动程序异常
		catch (ClassNotFoundException cnfex) {
			System.err.println("装载JDBC/ODBC驱动程序失败。");
			cnfex.printStackTrace();
			errorMessage="装载JDBC/ODBC驱动程序失败。";
			return ERROR;
		}
		// 捕获连接数据库异常
		catch (SQLException sqlex) {
			System.err.println("无法连接数据库");
			sqlex.printStackTrace();
			errorMessage="装载JDBC/ODBC驱动程序失败。";
			return ERROR;
		}

		return SUCCESS;
	}

}
